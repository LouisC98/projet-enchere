<head>
    <title>ENI Enchères - Mon profil</title>
</head>
<div th:replace="~{base :: layout(~{::title}, ~{::section})}">
    <section class="p-2 mt-5">
        <h3 class="text-center font-bold text-primary my-5 text-2xl">Mon profil</h3>

        <!-- Message de succès après modification -->
        <div id="messageSuccess" th:if="${successMessage}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 max-w-2xl mx-auto text-center font-bold">
            <span th:text="${successMessage}">Profil mis à jour avec succès</span>
        </div>

        <form id="profileForm" class="grid md:grid-cols-2 gap-2 md:gap-x-4 max-w-md md:max-w-2xl mx-auto px-4 items-center">
            <div class="grid grid-cols-2 items-center">
                <label for="pseudo" class="font-semibold">Pseudo :</label>
                <span id="pseudo-display" class="view-mode" th:text="${utilisateur.pseudo}"></span>
                <input type="text" id="pseudo" name="pseudo" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center">
                <label for="nom" class="font-semibold">Nom :</label>
                <span id="nom-display" class="view-mode" th:text="${utilisateur.nom}"></span>
                <input type="text" id="nom" name="nom" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center">
                <label for="prenom" class="font-semibold">Prénom :</label>
                <span id="prenom-display" class="view-mode" th:text="${utilisateur.prenom}"></span>
                <input type="text" id="prenom" name="prenom" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center">
                <label for="email" class="font-semibold">Email :</label>
                <span id="email-display" class="view-mode" th:text="${utilisateur.email}"></span>
                <input type="email" id="email" name="email" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center">
                <label for="telephone" class="font-semibold">Téléphone :</label>
                <span id="telephone-display" class="view-mode" th:text="${utilisateur.telephone}"></span>
                <input type="text" id="telephone" name="telephone" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center">
                <label for="rue" class="font-semibold">Rue :</label>
                <span id="rue-display" class="view-mode" th:text="${utilisateur.rue}"></span>
                <input type="text" id="rue" name="rue" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center">
                <label for="codePostal" class="font-semibold">Code postal :</label>
                <span id="codePostal-display" class="view-mode" th:text="${utilisateur.codePostal}"></span>
                <input type="text" id="codePostal" name="codePostal" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center">
                <label for="ville" class="font-semibold">Ville :</label>
                <span id="ville-display" class="view-mode" th:text="${utilisateur.ville}"></span>
                <input type="text" id="ville" name="ville" class="border p-1 rounded edit-mode hidden">
            </div>

            <div class="grid grid-cols-2 items-center edit-mode hidden">
                <label for="motDePasse" class="font-semibold">Mot de passe :</label>
                <input type="password" id="motDePasse" name="motDePasse" class="border p-1 rounded">
            </div>

            <div class="grid grid-cols-2 items-center edit-mode hidden">
                <label for="confirmation" class="font-semibold">Confirmation :</label>
                <input type="password" id="confirmation" name="confirmation" class="border p-1 rounded">
            </div>

            <div class="md:col-span-2 grid grid-cols-2 items-center my-4">
                <label for="credit" class="text-center font-semibold">Crédit :</label>
                <span id="credit-display" class="text-center font-bold" th:text="${utilisateur.credit}"></span>
            </div>

            <!-- Boutons en mode édition -->
            <div id="edit-buttons" class="md:col-span-2 grid grid-cols-3 mt-4 gap-3 edit-mode hidden">
                <button type="button" id="btn-save" class="p-3 rounded font-bold bg-primary text-white shadow text-shadow-sm cursor-pointer">Enregistrer</button>
                <button type="button" id="btn-delete" class="p-3 rounded font-bold bg-danger text-white shadow text-shadow-sm cursor-pointer">Supprimer mon compte</button>
                <button type="button" id="btn-cancel" class="p-3 rounded font-bold bg-secondary text-white shadow text-shadow-sm cursor-pointer">Retour</button>
            </div>

            <!-- Bouton en mode affichage -->
            <div id="view-button" class="md:col-span-2 text-center view-mode">
                <button type="button" id="btn-edit" class="p-3 rounded font-bold bg-accent text-white shadow text-shadow-sm cursor-pointer">Modifier</button>
            </div>
        </form>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButton = document.getElementById('btn-edit');
        const saveButton = document.getElementById('btn-save');
        const cancelButton = document.getElementById('btn-cancel');
        const deleteButton = document.getElementById('btn-delete');

        const viewElements = document.querySelectorAll('.view-mode');
        const editElements = document.querySelectorAll('.edit-mode');

        // Fonction pour passer en mode édition
        function enableEditMode() {
            viewElements.forEach(el => el.classList.add('hidden'));
            editElements.forEach(el => el.classList.remove('hidden'));

            // Remplir les inputs avec les valeurs affichées
            document.getElementById('pseudo').value = document.getElementById('pseudo-display').textContent;
            document.getElementById('nom').value = document.getElementById('nom-display').textContent;
            document.getElementById('prenom').value = document.getElementById('prenom-display').textContent;
            document.getElementById('email').value = document.getElementById('email-display').textContent;
            document.getElementById('telephone').value = document.getElementById('telephone-display').textContent;
            document.getElementById('rue').value = document.getElementById('rue-display').textContent;
            document.getElementById('codePostal').value = document.getElementById('codePostal-display').textContent;
            document.getElementById('ville').value = document.getElementById('ville-display').textContent;
        }

        // Fonction pour revenir en mode affichage
        function disableEditMode() {
            viewElements.forEach(el => el.classList.remove('hidden'));
            editElements.forEach(el => el.classList.add('hidden'));
        }

        // Fonction pour sauvegarder les modifications
        function saveChanges() {
            // Récupérer les valeurs des champs
            const userData = {
                id: document.getElementById('user-id') ? document.getElementById('user-id').value : null,
                pseudo: document.getElementById('pseudo').value,
                nom: document.getElementById('nom').value,
                prenom: document.getElementById('prenom').value,
                email: document.getElementById('email').value,
                telephone: document.getElementById('telephone').value,
                rue: document.getElementById('rue').value,
                codePostal: document.getElementById('codePostal').value,
                ville: document.getElementById('ville').value,
                motDePasse: document.getElementById('motDePasse').value,
                confirmation: document.getElementById('confirmation').value
            };

            // Appel AJAX pour mettre à jour le profil
            fetch('/profil/edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Erreur lors de la mise à jour du profil');
            })
            .then(data => {
                // Mise à jour des valeurs affichées
                document.getElementById('pseudo-display').textContent = userData.pseudo;
                document.getElementById('nom-display').textContent = userData.nom;
                document.getElementById('prenom-display').textContent = userData.prenom;
                document.getElementById('email-display').textContent = userData.email;
                document.getElementById('telephone-display').textContent = userData.telephone;
                document.getElementById('rue-display').textContent = userData.rue;
                document.getElementById('codePostal-display').textContent = userData.codePostal;
                document.getElementById('ville-display').textContent = userData.ville;

                // Afficher message de succès
                const messageSuccess = document.getElementById('messageSuccess');
                messageSuccess.classList.remove('hidden');
                messageSuccess.textContent = 'Profil mis à jour avec succès';
                setTimeout(() => {
                    messageSuccess.classList.add('hidden');
                }, 3000);

                disableEditMode();
            })
            .catch(error => {
                alert('Erreur: ' + error.message);
            });
        }

        // Gestion des événements
        editButton.addEventListener('click', enableEditMode);
        cancelButton.addEventListener('click', disableEditMode);
        saveButton.addEventListener('click', saveChanges);
        deleteButton.addEventListener('click', function() {
            if (confirm('Êtes-vous sûr de vouloir supprimer votre compte ?')) {
                // Appel à l'API de suppression
                fetch('/profil/delete', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/logout';
                    } else {
                        throw new Error('Erreur lors de la suppression du compte');
                    }
                })
                .catch(error => {
                    alert('Erreur: ' + error.message);
                });
            }
        });
    });
</script>